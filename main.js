/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// main.ts
var main_exports = {};
__export(main_exports, {
  default: () => CopyImageTextPlugin
});
module.exports = __toCommonJS(main_exports);
var import_obsidian = require("obsidian");
var CopyImageTextPlugin = class extends import_obsidian.Plugin {
  async onload() {
    this.addCommand({
      id: "copy-text",
      name: "\u590D\u5236\u6587\u672C\u548C\u56FE\u7247",
      editorCallback: (editor, view) => this.copyTextAndImages(editor, view),
      hotkeys: [{ modifiers: ["Mod", "Shift"], key: "c" }]
    });
  }
  async copyTextAndImages(editor, view) {
    try {
      console.log("\u5F00\u59CB\u590D\u5236\u6587\u672C\u548C\u56FE\u7247");
      let content = editor.getSelection();
      if (!content) {
        content = editor.getValue();
        console.log("\u6CA1\u6709\u9009\u4E2D\u6587\u672C,\u590D\u5236\u6574\u4E2A\u6587\u6863");
      } else {
        console.log("\u590D\u5236\u9009\u4E2D\u7684\u6587\u672C");
      }
      if (!view.file) {
        console.warn("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524D\u6587\u4EF6\u4FE1\u606F");
        new import_obsidian.Notice("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524D\u6587\u4EF6\u4FE1\u606F\uFF0C\u590D\u5236\u53EF\u80FD\u4E0D\u5B8C\u6574");
        return;
      }
      const htmlContent = await this.convertToHtml(content, view.file);
      await navigator.clipboard.write([
        new ClipboardItem({
          "text/html": new Blob([htmlContent], { type: "text/html" }),
          "text/plain": new Blob([content], { type: "text/plain" })
        })
      ]);
      console.log("\u6210\u529F\u590D\u5236\u5230\u526A\u8D34\u677F");
      new import_obsidian.Notice("\u5185\u5BB9\u5DF2\u6210\u529F\u590D\u5236");
    } catch (error) {
      console.error("\u590D\u5236\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF:", error);
      new import_obsidian.Notice("\u590D\u5236\u5931\u8D25,\u8BF7\u67E5\u770B\u63A7\u5236\u53F0\u4EE5\u83B7\u53D6\u66F4\u591A\u4FE1\u606F");
    }
  }
  async convertToHtml(content, file) {
    const imageRegex = /!\[\[(.*?)\]\]/g;
    const replacements = await Promise.all(Array.from(content.matchAll(imageRegex)).map((match) => this.replaceImageWithBase64(match[1], file)));
    let htmlContent = content;
    replacements.forEach(({ original, replacement }) => {
      htmlContent = htmlContent.replace(original, replacement);
    });
    htmlContent = htmlContent.replace(/^---$/gm, '<hr style="border: 0; border-top: 1px solid #ddd; margin: 20px 0;">');
    htmlContent = htmlContent.replace(/```([\s\S]*?)```/g, (match, code) => {
      const escapedCode = this.escapeHtml(code.trim());
      return `<pre style="background-color: #f6f8fa; border-radius: 3px; padding: 16px; overflow: auto;"><code style="font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; font-size: 14px; line-height: 1.5;">${escapedCode}</code></pre>`;
    });
    htmlContent = htmlContent.replace(/^(#+)\s+(.*?)$/gm, (match, hashes, title) => {
      const level = hashes.length;
      const fontSize = 28 - level * 2;
      return `<h${level} style="font-size: ${fontSize}px; font-weight: bold; margin: 10px 0;">${title}</h${level}>`;
    });
    htmlContent = htmlContent.replace(/\n/g, "<br>").replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>").replace(/\*(.+?)\*/g, "<em>$1</em>").replace(/`(.+?)`/g, '<code style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 3px;">$1</code>').replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" style="color: #576b95; text-decoration: none;">$1</a>');
    return `<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; color: #333; line-height: 1.6;">${htmlContent}</div>`;
  }
  async replaceImageWithBase64(imagePath, file) {
    try {
      console.log(`\u5C1D\u8BD5\u5904\u7406\u56FE\u7247: ${imagePath}`);
      const fileName = imagePath.split("/").pop() || imagePath;
      console.log(`\u56FE\u7247\u6587\u4EF6\u540D: ${fileName}`);
      const imageFile = this.app.vault.getFiles().find((f) => f.name.toLowerCase().includes(fileName.toLowerCase()));
      if (!imageFile) {
        console.warn(`\u56FE\u7247\u672A\u627E\u5230: ${imagePath}`);
        return { original: `![[${imagePath}]]`, replacement: `[\u56FE\u7247\u672A\u627E\u5230: ${imagePath}]` };
      }
      console.log(`\u627E\u5230\u56FE\u7247\u6587\u4EF6: ${imageFile.path}`);
      const stat = await this.app.vault.adapter.stat(imageFile.path);
      if (stat) {
        const fileSize = stat.size;
        const maxSize = 10 * 1024 * 1024;
        if (fileSize > maxSize) {
          console.warn(`\u56FE\u7247\u6587\u4EF6\u8FC7\u5927: ${fileSize} \u5B57\u8282\uFF0C\u8D85\u8FC7 ${maxSize} \u5B57\u8282\u9650\u5236`);
          return { original: `![[${imagePath}]]`, replacement: `[\u56FE\u7247\u6587\u4EF6\u8FC7\u5927: ${imagePath}]` };
        }
      }
      const imageArrayBuffer = await this.app.vault.readBinary(imageFile);
      console.log(`\u6210\u529F\u8BFB\u53D6\u56FE\u7247\u6570\u636E,\u5927\u5C0F: ${imageArrayBuffer.byteLength} \u5B57\u8282`);
      let base64;
      try {
        base64 = await this.arrayBufferToBase64(imageArrayBuffer);
        console.log(`\u6210\u529F\u8F6C\u6362\u4E3ABase64,\u957F\u5EA6: ${base64.length}`);
      } catch (error) {
        console.error(`Base64\u8F6C\u6362\u5931\u8D25:`, error);
        return { original: `![[${imagePath}]]`, replacement: `[\u56FE\u7247Base64\u8F6C\u6362\u5931\u8D25: ${imagePath}]` };
      }
      const mimeType = this.getMimeType(imagePath);
      console.log(`\u6210\u529F\u5904\u7406\u56FE\u7247: ${imagePath}, MIME\u7C7B\u578B: ${mimeType}`);
      return {
        original: `![[${imagePath}]]`,
        replacement: `<img src="data:${mimeType};base64,${base64}" alt="${imagePath}" style="max-width: 100%;">`
      };
    } catch (error) {
      console.error(`\u5904\u7406\u56FE\u7247\u65F6\u51FA\u9519 (${imagePath}):`, error);
      console.error("\u9519\u8BEF\u5806\u6808:", error.stack);
      return { original: `![[${imagePath}]]`, replacement: `[\u56FE\u7247\u5904\u7406\u9519\u8BEF: ${imagePath}]` };
    }
  }
  arrayBufferToBase64(buffer) {
    return new Promise((resolve, reject) => {
      const blob = new Blob([buffer]);
      const reader = new FileReader();
      reader.onload = () => {
        var _a;
        const base64 = (_a = reader.result) == null ? void 0 : _a.toString().split(",")[1];
        resolve(base64 || "");
      };
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }
  getMimeType(filename) {
    var _a;
    const ext = (_a = filename.split(".").pop()) == null ? void 0 : _a.toLowerCase();
    console.log(`\u6587\u4EF6\u6269\u5C55\u540D: ${ext}`);
    switch (ext) {
      case "jpg":
      case "jpeg":
        return "image/jpeg";
      case "png":
        return "image/png";
      case "gif":
        return "image/gif";
      case "webp":
        return "image/webp";
      case "svg":
        return "image/svg+xml";
      default:
        console.warn(`\u672A\u77E5\u7684\u6587\u4EF6\u6269\u5C55\u540D: ${ext},\u4F7F\u7528\u9ED8\u8BA4MIME\u7C7B\u578B`);
        return "image/png";
    }
  }
  escapeHtml(unsafe) {
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsibWFpbi50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHsgRWRpdG9yLCBNYXJrZG93blZpZXcsIE5vdGljZSwgUGx1Z2luLCBURmlsZSwgVEFic3RyYWN0RmlsZSB9IGZyb20gJ29ic2lkaWFuJztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENvcHlJbWFnZVRleHRQbHVnaW4gZXh0ZW5kcyBQbHVnaW4ge1xyXG4gIGFzeW5jIG9ubG9hZCgpIHtcclxuICAgIHRoaXMuYWRkQ29tbWFuZCh7XHJcbiAgICAgIGlkOiAnY29weS10ZXh0JyxcclxuICAgICAgbmFtZTogJ1x1NTkwRFx1NTIzNlx1NjU4N1x1NjcyQ1x1NTQ4Q1x1NTZGRVx1NzI0NycsXHJcbiAgICAgIGVkaXRvckNhbGxiYWNrOiAoZWRpdG9yOiBFZGl0b3IsIHZpZXc6IE1hcmtkb3duVmlldykgPT4gdGhpcy5jb3B5VGV4dEFuZEltYWdlcyhlZGl0b3IsIHZpZXcpLFxyXG4gICAgICBob3RrZXlzOiBbeyBtb2RpZmllcnM6IFtcIk1vZFwiLCBcIlNoaWZ0XCJdLCBrZXk6IFwiY1wiIH1dXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGNvcHlUZXh0QW5kSW1hZ2VzKGVkaXRvcjogRWRpdG9yLCB2aWV3OiBNYXJrZG93blZpZXcpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdcdTVGMDBcdTU5Q0JcdTU5MERcdTUyMzZcdTY1ODdcdTY3MkNcdTU0OENcdTU2RkVcdTcyNDcnKTtcclxuICAgICAgbGV0IGNvbnRlbnQgPSBlZGl0b3IuZ2V0U2VsZWN0aW9uKCk7XHJcbiAgICAgIFxyXG4gICAgICBpZiAoIWNvbnRlbnQpIHtcclxuICAgICAgICBjb250ZW50ID0gZWRpdG9yLmdldFZhbHVlKCk7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ1x1NkNBMVx1NjcwOVx1OTAwOVx1NEUyRFx1NjU4N1x1NjcyQyxcdTU5MERcdTUyMzZcdTY1NzRcdTRFMkFcdTY1ODdcdTY4NjMnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnXHU1OTBEXHU1MjM2XHU5MDA5XHU0RTJEXHU3Njg0XHU2NTg3XHU2NzJDJyk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmICghdmlldy5maWxlKSB7XHJcbiAgICAgICAgY29uc29sZS53YXJuKCdcdTY1RTBcdTZDRDVcdTgzQjdcdTUzRDZcdTVGNTNcdTUyNERcdTY1ODdcdTRFRjZcdTRGRTFcdTYwNkYnKTtcclxuICAgICAgICBuZXcgTm90aWNlKCdcdTY1RTBcdTZDRDVcdTgzQjdcdTUzRDZcdTVGNTNcdTUyNERcdTY1ODdcdTRFRjZcdTRGRTFcdTYwNkZcdUZGMENcdTU5MERcdTUyMzZcdTUzRUZcdTgwRkRcdTRFMERcdTVCOENcdTY1NzQnKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGh0bWxDb250ZW50ID0gYXdhaXQgdGhpcy5jb252ZXJ0VG9IdG1sKGNvbnRlbnQsIHZpZXcuZmlsZSk7XHJcbiAgICAgIFxyXG4gICAgICBhd2FpdCBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlKFtcclxuICAgICAgICBuZXcgQ2xpcGJvYXJkSXRlbSh7XHJcbiAgICAgICAgICAndGV4dC9odG1sJzogbmV3IEJsb2IoW2h0bWxDb250ZW50XSwgeyB0eXBlOiAndGV4dC9odG1sJyB9KSxcclxuICAgICAgICAgICd0ZXh0L3BsYWluJzogbmV3IEJsb2IoW2NvbnRlbnRdLCB7IHR5cGU6ICd0ZXh0L3BsYWluJyB9KVxyXG4gICAgICAgIH0pXHJcbiAgICAgIF0pO1xyXG4gICAgICBcclxuICAgICAgY29uc29sZS5sb2coJ1x1NjIxMFx1NTI5Rlx1NTkwRFx1NTIzNlx1NTIzMFx1NTI2QVx1OEQzNFx1Njc3RicpO1xyXG4gICAgICBuZXcgTm90aWNlKCdcdTUxODVcdTVCQjlcdTVERjJcdTYyMTBcdTUyOUZcdTU5MERcdTUyMzYnKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1x1NTkwRFx1NTIzNlx1OEZDN1x1N0EwQlx1NEUyRFx1NTNEMVx1NzUxRlx1OTUxOVx1OEJFRjonLCBlcnJvcik7XHJcbiAgICAgIG5ldyBOb3RpY2UoJ1x1NTkwRFx1NTIzNlx1NTkzMVx1OEQyNSxcdThCRjdcdTY3RTVcdTc3MEJcdTYzQTdcdTUyMzZcdTUzRjBcdTRFRTVcdTgzQjdcdTUzRDZcdTY2RjRcdTU5MUFcdTRGRTFcdTYwNkYnKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGNvbnZlcnRUb0h0bWwoY29udGVudDogc3RyaW5nLCBmaWxlOiBURmlsZSk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICBjb25zdCBpbWFnZVJlZ2V4ID0gLyFcXFtcXFsoLio/KVxcXVxcXS9nO1xyXG4gICAgY29uc3QgcmVwbGFjZW1lbnRzID0gYXdhaXQgUHJvbWlzZS5hbGwoQXJyYXkuZnJvbShjb250ZW50Lm1hdGNoQWxsKGltYWdlUmVnZXgpKS5tYXAoXHJcbiAgICAgIG1hdGNoID0+IHRoaXMucmVwbGFjZUltYWdlV2l0aEJhc2U2NChtYXRjaFsxXSwgZmlsZSlcclxuICAgICkpO1xyXG4gICAgXHJcbiAgICBsZXQgaHRtbENvbnRlbnQgPSBjb250ZW50O1xyXG4gICAgcmVwbGFjZW1lbnRzLmZvckVhY2goKHsgb3JpZ2luYWwsIHJlcGxhY2VtZW50IH0pID0+IHtcclxuICAgICAgaHRtbENvbnRlbnQgPSBodG1sQ29udGVudC5yZXBsYWNlKG9yaWdpbmFsLCByZXBsYWNlbWVudCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBcdTU5MDRcdTc0MDZcdTUyMDZcdTUyNzJcdTdFQkZcclxuICAgIGh0bWxDb250ZW50ID0gaHRtbENvbnRlbnQucmVwbGFjZSgvXi0tLSQvZ20sICc8aHIgc3R5bGU9XCJib3JkZXI6IDA7IGJvcmRlci10b3A6IDFweCBzb2xpZCAjZGRkOyBtYXJnaW46IDIwcHggMDtcIj4nKTtcclxuXHJcbiAgICAvLyBcdTU5MDRcdTc0MDZcdTRFRTNcdTc4MDFcdTU3NTdcclxuICAgIGh0bWxDb250ZW50ID0gaHRtbENvbnRlbnQucmVwbGFjZSgvYGBgKFtcXHNcXFNdKj8pYGBgL2csIChtYXRjaCwgY29kZSkgPT4ge1xyXG4gICAgICBjb25zdCBlc2NhcGVkQ29kZSA9IHRoaXMuZXNjYXBlSHRtbChjb2RlLnRyaW0oKSk7XHJcbiAgICAgIHJldHVybiBgPHByZSBzdHlsZT1cImJhY2tncm91bmQtY29sb3I6ICNmNmY4ZmE7IGJvcmRlci1yYWRpdXM6IDNweDsgcGFkZGluZzogMTZweDsgb3ZlcmZsb3c6IGF1dG87XCI+PGNvZGUgc3R5bGU9XCJmb250LWZhbWlseTogQ29uc29sYXMsIE1vbmFjbywgJ0FuZGFsZSBNb25vJywgJ1VidW50dSBNb25vJywgbW9ub3NwYWNlOyBmb250LXNpemU6IDE0cHg7IGxpbmUtaGVpZ2h0OiAxLjU7XCI+JHtlc2NhcGVkQ29kZX08L2NvZGU+PC9wcmU+YDtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIFx1NTkwNFx1NzQwNlx1NjgwN1x1OTg5OFxyXG4gICAgaHRtbENvbnRlbnQgPSBodG1sQ29udGVudC5yZXBsYWNlKC9eKCMrKVxccysoLio/KSQvZ20sIChtYXRjaCwgaGFzaGVzLCB0aXRsZSkgPT4ge1xyXG4gICAgICBjb25zdCBsZXZlbCA9IGhhc2hlcy5sZW5ndGg7XHJcbiAgICAgIGNvbnN0IGZvbnRTaXplID0gMjggLSAobGV2ZWwgKiAyKTsgLy8gXHU0RTAwXHU3RUE3XHU2ODA3XHU5ODk4MjhweFx1RkYwQ1x1OTAxMFx1N0VBN1x1OTAxMlx1NTFDRlxyXG4gICAgICByZXR1cm4gYDxoJHtsZXZlbH0gc3R5bGU9XCJmb250LXNpemU6ICR7Zm9udFNpemV9cHg7IGZvbnQtd2VpZ2h0OiBib2xkOyBtYXJnaW46IDEwcHggMDtcIj4ke3RpdGxlfTwvaCR7bGV2ZWx9PmA7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBcdTUxNzZcdTRFRDYgTWFya2Rvd24gXHU1MjMwIEhUTUwgXHU3Njg0XHU4RjZDXHU2MzYyXHJcbiAgICBodG1sQ29udGVudCA9IGh0bWxDb250ZW50XHJcbiAgICAgIC5yZXBsYWNlKC9cXG4vZywgJzxicj4nKVxyXG4gICAgICAucmVwbGFjZSgvXFwqXFwqKC4rPylcXCpcXCovZywgJzxzdHJvbmc+JDE8L3N0cm9uZz4nKVxyXG4gICAgICAucmVwbGFjZSgvXFwqKC4rPylcXCovZywgJzxlbT4kMTwvZW0+JylcclxuICAgICAgLnJlcGxhY2UoL2AoLis/KWAvZywgJzxjb2RlIHN0eWxlPVwiYmFja2dyb3VuZC1jb2xvcjogI2YwZjBmMDsgcGFkZGluZzogMnB4IDRweDsgYm9yZGVyLXJhZGl1czogM3B4O1wiPiQxPC9jb2RlPicpXHJcbiAgICAgIC5yZXBsYWNlKC9cXFsoLis/KVxcXVxcKCguKz8pXFwpL2csICc8YSBocmVmPVwiJDJcIiBzdHlsZT1cImNvbG9yOiAjNTc2Yjk1OyB0ZXh0LWRlY29yYXRpb246IG5vbmU7XCI+JDE8L2E+Jyk7XHJcblxyXG4gICAgcmV0dXJuIGA8ZGl2IHN0eWxlPVwiZm9udC1mYW1pbHk6IC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgJ1NlZ29lIFVJJywgUm9ib3RvLCBPeHlnZW4sIFVidW50dSwgQ2FudGFyZWxsLCAnT3BlbiBTYW5zJywgJ0hlbHZldGljYSBOZXVlJywgc2Fucy1zZXJpZjsgY29sb3I6ICMzMzM7IGxpbmUtaGVpZ2h0OiAxLjY7XCI+JHtodG1sQ29udGVudH08L2Rpdj5gO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgcmVwbGFjZUltYWdlV2l0aEJhc2U2NChpbWFnZVBhdGg6IHN0cmluZywgZmlsZTogVEZpbGUpOiBQcm9taXNlPHsgb3JpZ2luYWw6IHN0cmluZywgcmVwbGFjZW1lbnQ6IHN0cmluZyB9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zb2xlLmxvZyhgXHU1QzFEXHU4QkQ1XHU1OTA0XHU3NDA2XHU1NkZFXHU3MjQ3OiAke2ltYWdlUGF0aH1gKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFx1ODNCN1x1NTNENlx1NjU4N1x1NEVGNlx1NTQwRFx1OTBFOFx1NTIwNlxyXG4gICAgICBjb25zdCBmaWxlTmFtZSA9IGltYWdlUGF0aC5zcGxpdCgnLycpLnBvcCgpIHx8IGltYWdlUGF0aDtcclxuICAgICAgY29uc29sZS5sb2coYFx1NTZGRVx1NzI0N1x1NjU4N1x1NEVGNlx1NTQwRDogJHtmaWxlTmFtZX1gKTtcclxuICAgICAgXHJcbiAgICAgIC8vIFx1NjQxQ1x1N0QyMlx1NjU3NFx1NEUyQSB2YXVsdCBcdTRFMkRcdTc2ODRcdTU2RkVcdTcyNDdcdTY1ODdcdTRFRjYsXHU0RjdGXHU3NTI4XHU5MEU4XHU1MjA2XHU2NTg3XHU0RUY2XHU1NDBEXHU1MzM5XHU5MTREXHJcbiAgICAgIGNvbnN0IGltYWdlRmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEZpbGVzKCkuZmluZChmID0+IFxyXG4gICAgICAgIGYubmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGZpbGVOYW1lLnRvTG93ZXJDYXNlKCkpXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBpZiAoIWltYWdlRmlsZSkge1xyXG4gICAgICAgIGNvbnNvbGUud2FybihgXHU1NkZFXHU3MjQ3XHU2NzJBXHU2MjdFXHU1MjMwOiAke2ltYWdlUGF0aH1gKTtcclxuICAgICAgICByZXR1cm4geyBvcmlnaW5hbDogYCFbWyR7aW1hZ2VQYXRofV1dYCwgcmVwbGFjZW1lbnQ6IGBbXHU1NkZFXHU3MjQ3XHU2NzJBXHU2MjdFXHU1MjMwOiAke2ltYWdlUGF0aH1dYCB9O1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zb2xlLmxvZyhgXHU2MjdFXHU1MjMwXHU1NkZFXHU3MjQ3XHU2NTg3XHU0RUY2OiAke2ltYWdlRmlsZS5wYXRofWApO1xyXG5cclxuICAgICAgLy8gXHU2OEMwXHU2N0U1XHU2NTg3XHU0RUY2XHU1OTI3XHU1QzBGXHJcbiAgICAgIGNvbnN0IHN0YXQgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5hZGFwdGVyLnN0YXQoaW1hZ2VGaWxlLnBhdGgpO1xyXG4gICAgICBpZiAoc3RhdCkge1xyXG4gICAgICAgIGNvbnN0IGZpbGVTaXplID0gc3RhdC5zaXplO1xyXG4gICAgICAgIGNvbnN0IG1heFNpemUgPSAxMCAqIDEwMjQgKiAxMDI0OyAvLyAxME1CXHJcbiAgICAgICAgaWYgKGZpbGVTaXplID4gbWF4U2l6ZSkge1xyXG4gICAgICAgICAgY29uc29sZS53YXJuKGBcdTU2RkVcdTcyNDdcdTY1ODdcdTRFRjZcdThGQzdcdTU5Mjc6ICR7ZmlsZVNpemV9IFx1NUI1N1x1ODI4Mlx1RkYwQ1x1OEQ4NVx1OEZDNyAke21heFNpemV9IFx1NUI1N1x1ODI4Mlx1OTY1MFx1NTIzNmApO1xyXG4gICAgICAgICAgcmV0dXJuIHsgb3JpZ2luYWw6IGAhW1ske2ltYWdlUGF0aH1dXWAsIHJlcGxhY2VtZW50OiBgW1x1NTZGRVx1NzI0N1x1NjU4N1x1NEVGNlx1OEZDN1x1NTkyNzogJHtpbWFnZVBhdGh9XWAgfTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGltYWdlQXJyYXlCdWZmZXIgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5yZWFkQmluYXJ5KGltYWdlRmlsZSk7XHJcbiAgICAgIGNvbnNvbGUubG9nKGBcdTYyMTBcdTUyOUZcdThCRkJcdTUzRDZcdTU2RkVcdTcyNDdcdTY1NzBcdTYzNkUsXHU1OTI3XHU1QzBGOiAke2ltYWdlQXJyYXlCdWZmZXIuYnl0ZUxlbmd0aH0gXHU1QjU3XHU4MjgyYCk7XHJcblxyXG4gICAgICBsZXQgYmFzZTY0O1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGJhc2U2NCA9IGF3YWl0IHRoaXMuYXJyYXlCdWZmZXJUb0Jhc2U2NChpbWFnZUFycmF5QnVmZmVyKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhgXHU2MjEwXHU1MjlGXHU4RjZDXHU2MzYyXHU0RTNBQmFzZTY0LFx1OTU3Rlx1NUVBNjogJHtiYXNlNjQubGVuZ3RofWApO1xyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYEJhc2U2NFx1OEY2Q1x1NjM2Mlx1NTkzMVx1OEQyNTpgLCBlcnJvcik7XHJcbiAgICAgICAgcmV0dXJuIHsgb3JpZ2luYWw6IGAhW1ske2ltYWdlUGF0aH1dXWAsIHJlcGxhY2VtZW50OiBgW1x1NTZGRVx1NzI0N0Jhc2U2NFx1OEY2Q1x1NjM2Mlx1NTkzMVx1OEQyNTogJHtpbWFnZVBhdGh9XWAgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgbWltZVR5cGUgPSB0aGlzLmdldE1pbWVUeXBlKGltYWdlUGF0aCk7XHJcbiAgICAgIGNvbnNvbGUubG9nKGBcdTYyMTBcdTUyOUZcdTU5MDRcdTc0MDZcdTU2RkVcdTcyNDc6ICR7aW1hZ2VQYXRofSwgTUlNRVx1N0M3Qlx1NTc4QjogJHttaW1lVHlwZX1gKTtcclxuXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgb3JpZ2luYWw6IGAhW1ske2ltYWdlUGF0aH1dXWAsXHJcbiAgICAgICAgcmVwbGFjZW1lbnQ6IGA8aW1nIHNyYz1cImRhdGE6JHttaW1lVHlwZX07YmFzZTY0LCR7YmFzZTY0fVwiIGFsdD1cIiR7aW1hZ2VQYXRofVwiIHN0eWxlPVwibWF4LXdpZHRoOiAxMDAlO1wiPmBcclxuICAgICAgfTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoYFx1NTkwNFx1NzQwNlx1NTZGRVx1NzI0N1x1NjVGNlx1NTFGQVx1OTUxOSAoJHtpbWFnZVBhdGh9KTpgLCBlcnJvcik7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1x1OTUxOVx1OEJFRlx1NTgwNlx1NjgwODonLCBlcnJvci5zdGFjayk7XHJcbiAgICAgIHJldHVybiB7IG9yaWdpbmFsOiBgIVtbJHtpbWFnZVBhdGh9XV1gLCByZXBsYWNlbWVudDogYFtcdTU2RkVcdTcyNDdcdTU5MDRcdTc0MDZcdTk1MTlcdThCRUY6ICR7aW1hZ2VQYXRofV1gIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhcnJheUJ1ZmZlclRvQmFzZTY0KGJ1ZmZlcjogQXJyYXlCdWZmZXIpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtidWZmZXJdKTtcclxuICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcclxuICAgICAgcmVhZGVyLm9ubG9hZCA9ICgpID0+IHtcclxuICAgICAgICBjb25zdCBiYXNlNjQgPSByZWFkZXIucmVzdWx0Py50b1N0cmluZygpLnNwbGl0KCcsJylbMV07XHJcbiAgICAgICAgcmVzb2x2ZShiYXNlNjQgfHwgJycpO1xyXG4gICAgICB9O1xyXG4gICAgICByZWFkZXIub25lcnJvciA9IHJlamVjdDtcclxuICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoYmxvYik7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldE1pbWVUeXBlKGZpbGVuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgZXh0ID0gZmlsZW5hbWUuc3BsaXQoJy4nKS5wb3AoKT8udG9Mb3dlckNhc2UoKTtcclxuICAgIGNvbnNvbGUubG9nKGBcdTY1ODdcdTRFRjZcdTYyNjlcdTVDNTVcdTU0MEQ6ICR7ZXh0fWApO1xyXG4gICAgc3dpdGNoIChleHQpIHtcclxuICAgICAgY2FzZSAnanBnJzpcclxuICAgICAgY2FzZSAnanBlZyc6XHJcbiAgICAgICAgcmV0dXJuICdpbWFnZS9qcGVnJztcclxuICAgICAgY2FzZSAncG5nJzpcclxuICAgICAgICByZXR1cm4gJ2ltYWdlL3BuZyc7XHJcbiAgICAgIGNhc2UgJ2dpZic6XHJcbiAgICAgICAgcmV0dXJuICdpbWFnZS9naWYnO1xyXG4gICAgICBjYXNlICd3ZWJwJzpcclxuICAgICAgICByZXR1cm4gJ2ltYWdlL3dlYnAnO1xyXG4gICAgICBjYXNlICdzdmcnOlxyXG4gICAgICAgIHJldHVybiAnaW1hZ2Uvc3ZnK3htbCc7XHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgY29uc29sZS53YXJuKGBcdTY3MkFcdTc3RTVcdTc2ODRcdTY1ODdcdTRFRjZcdTYyNjlcdTVDNTVcdTU0MEQ6ICR7ZXh0fSxcdTRGN0ZcdTc1MjhcdTlFRDhcdThCQTRNSU1FXHU3QzdCXHU1NzhCYCk7XHJcbiAgICAgICAgcmV0dXJuICdpbWFnZS9wbmcnOyAgLy8gXHU5RUQ4XHU4QkE0XHU0RjdGXHU3NTI4IFBORyBcdTdDN0JcdTU3OEJcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIFx1NkRGQlx1NTJBMFx1OEZEOVx1NEUyQVx1OEY4NVx1NTJBOVx1NjVCOVx1NkNENVx1Njc2NVx1OEY2Q1x1NEU0OSBIVE1MIFx1NzI3OVx1NkI4QVx1NUI1N1x1N0IyNlxyXG4gIHByaXZhdGUgZXNjYXBlSHRtbCh1bnNhZmU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdW5zYWZlXHJcbiAgICAgIC5yZXBsYWNlKC8mL2csIFwiJmFtcDtcIilcclxuICAgICAgLnJlcGxhY2UoLzwvZywgXCImbHQ7XCIpXHJcbiAgICAgIC5yZXBsYWNlKC8+L2csIFwiJmd0O1wiKVxyXG4gICAgICAucmVwbGFjZSgvXCIvZywgXCImcXVvdDtcIilcclxuICAgICAgLnJlcGxhY2UoLycvZywgXCImIzAzOTtcIik7XHJcbiAgfVxyXG59Il0sCiAgIm1hcHBpbmdzIjogIjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLHNCQUEyRTtBQUUzRSxJQUFxQixzQkFBckIsY0FBaUQsdUJBQU87QUFBQSxFQUN0RCxNQUFNLFNBQVM7QUFDYixTQUFLLFdBQVc7QUFBQSxNQUNkLElBQUk7QUFBQSxNQUNKLE1BQU07QUFBQSxNQUNOLGdCQUFnQixDQUFDLFFBQWdCLFNBQXVCLEtBQUssa0JBQWtCLFFBQVEsSUFBSTtBQUFBLE1BQzNGLFNBQVMsQ0FBQyxFQUFFLFdB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
